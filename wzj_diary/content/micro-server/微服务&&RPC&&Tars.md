## 微服务架构 && RPC框架 && Tencent/Tars简介
@(王镇佳)

### 一、微服务架构
> 1.什么是微服务架构？

微服务是一种架构风格，一个大型复杂软件应用由一个或多个微服务组成。系统中的各个微服务可被独立部署，各个微服务之间是松耦合的。每个微服务仅关注于完成一件任务并很好地完成该任务。在所有情况下，每个任务代表着一个小的业务能力。


使用微服务最重要的一点，能够独立修改和部署单个服务，而不需要修改系统的其他部分。


传统的架构

   
> 2.传统单体架构的缺点？

首先来了解下单体架构的一些弊端：
1. `巨大代码库`
	特别是对那些团队新成员来说。应用难以被理解和进行修改，进而导致开发速度减慢。
2. `持续部署困难`
    巨大的单体应用本身就是频繁部署的一大障碍。为了更新一个组件，你必须重新部署整个应用。
3. `应用扩展困难`
	单体架构只能进行一维伸缩。一方面，它可以通过运行多个应用副本来增加业务容量，实现扩展。一些云服务甚至可以根据负载量动态调整实例数量。但在另一方面，数据量增大会使得该架构无法伸缩。每个应用实例需要访问所有数据，导致缓存低效，加大内存占用和I/O流量。另外，不同的应用组件有不同的资源需求——有的是CPU密集型的，另外一些是内存密集型的。单体架构无法单独伸缩每个组件。
4. `难以进行规模化开发`
	单体应用是规模化开发的障碍。应用一旦达到特定规模，需要将现有组织拆分成多个团队，每个团队负责不同的功能模块。举例来说，我们可能需要设立UI团队、会计团队、库存团队等等。单体应用的问题在于它使团队无法独立展开工作。团队需要在工作进度和重新部署上进行协调。对于各团队而言，这使得变更和更新产品变得异常困难。
5. `单体架构迫使我们长期选择开发初期选定的技术栈`

> 3.微服务的优缺点？

微服务架构是一种能够解决单体架构各种局限的备选模式。
`优点`
+ 每个服务都比较简单，只关注于一个业务功能。
+ 微服务架构方式是松耦合的，可以提供更高的灵活性。
+ 微服务可通过最佳及最合适的不同的编程语言与工具进行开发，能够做到有的放矢地解决针对性问题。
+ 每个微服务可由不同团队独立开发，互不影响，加快推出市场的速度。
+ 微服务架构是持续交付(CD)的巨大推动力，允许在频繁发布不同服务的同时保持系统其他部分的可用性和稳定性。

`缺点`

+ `运维开销及成本增加`：
	整体应用可能只需部署至一小片应用服务区集群，而微服务架构可能变成需要构建/测试/部署/运行数十个独立的服务，并可能需要支持多种语言和环境。这导致一个整体式系统如果由20个微服务组成，可能需要40~60个进程。

+ `必须有坚实的开发运维一体化技能`：开发人员需要熟知运维与投产环境，开发人员也需要掌握必要的数据存储技术如NoSQL，具有较强DevOps技能的人员比较稀缺，会带来招聘人才方面的挑战。

+ `代码重复`：某些底层功能需要被多个服务所用，为了避免将“同步耦合引入到系统中”，有时需要向不同服务添加一些代码，这就会导致代码重复。

+ `分布式系统的复杂性`：作为一种分布式系统，微服务引入了复杂性和其他若干问题，例如网络延迟、容错性、消息序列化、不可靠的网络、异步机制、版本化、差异化的工作负载等，开发人员需要考虑以上的分布式系统问题。
异步机制：微服务往往使用异步编程、消息与并行机制，如果应用存在跨微服务的事务性处理，其实现机制会变得复杂化。

+ `可测性的挑战`：在动态环境下服务间的交互会产生非常微妙的行为，难以可视化及全面测试。经典微服务往往不太重视测试，更多的是通过监控发现生产环境的异常，进而快速回滚或采取其他必要的行动。但对于特别在意风险规避监管或投产环境错误会产生显著影响的场景下需要特别注意。

除此之外，如何合理地划分系统的原组织结构，是垂直划分（如数据层），还是按照原来进程的内部API水平进行划分？


### 二、常见RPC框架
> 为什么使用RPC框架？ 

微服务架构会将单体应用拆分为多个服务，服务间的交流使用RPC（远程过程调用）因为RPC的性能更好，如果是自己实现的话，那就需要自己去实现序列化、反序列化、网络框架、连接池、收发线程、超时处理、状态机。

RPC 框架要向调用方屏蔽各种复杂性，要向服务提供方也屏蔽各类复杂性  ：
（ 1 ）调用方感觉就像调用本地函数一样
（ 2 ）服务提供方感觉就像实现一个本地函数一样来实现服务

> 主流的开源RPC框架有哪些？

`阿里的Dubbo`

Dubbo 是阿里巴巴公司开源的一个Java高性能优秀的服务框架，使得应用可通过高性能的 RPC 实现服务的输出和输入功能，可以和 Spring框架无缝集成。不过，略有遗憾的是，据说在淘宝内部，dubbo由于跟淘宝另一个类似的框架HSF（非开源）有竞争关系，导致dubbo团队已经解散。Dubbo现在由另一个团队（当当）在维护，为Dubbox。

![Alt text](./1493865993708.png)

`当当的Dubbox`
![Alt text](./1493867119043.png)

`微博的Motan`
Motan是新浪微博开源的一个Java 框架。它诞生的比较晚，起于2013年，2016年5月开源。Motan 在微博平台中已经广泛应用，每天为数百个服务完成近千亿次的调用。
![Alt text](./1493867528551.png)

`谷歌的gRPC`
gRPC是Google开发的高性能、通用的开源RPC框架，其由Google主要面向移动应用开发并基于HTTP/2协议标准而设计，基于ProtoBuf(Protocol Buffers)序列化协议开发，且支持众多开发语言。本身它不是分布式的，所以要实现上面的框架的功能需要进一步的开发。
![Alt text](./1493867587677.png)

`腾讯的Tars`
Tars是腾讯从2008年到今天一直在使用的后台逻辑层的统一应用框架TAF（Total Application Framework），目前支持C++和Java两种语言。该框架为用户提供了涉及到开发、运维、以及测试的一整套解决方案，帮助一个产品或者服务快速开发、部署、测试、上线。 它集可扩展协议编解码、高性能RPC通信框架、名字路由与发现、发布监控、日志统计、配置管理等于一体，通过它可以快速用微服务的方式构建自己的稳定可靠的分布式应用，并实现完整有效的服务治理。
![Alt text](./1493867628007.png)


### 三、Tars简介
Tars于2017年开源，Tars是基于`名字服务`使用Tars协议的`高性能RPC`开发框架，同时配套一体化的`服务治理平台`，帮助个人或者企业快速的以微服务的方式构建自己稳定可靠的分布式应用。目前支持`C++`和`JAVA`

> 整体架构拓扑图：

![Alt text](./1493869435846.png)

`服务节点`:  服务节点可以认为是服务所实际运行的一个具体的操作系统实例，可以是物理主机或者虚拟主机、云主机。随着服务的种类扩展和规模扩大，服务节点可能成千上万甚至数以十万计。

每台服务节点上均有`一个Node服务节点`和`N(N>=0)个业务服务节点`，Node服务节点会对业务服务节点进行统一管理，提供启停、发布、监控等功能，同时接收业务服务节点上报过来的心跳。

`公共框架节点`:
1. `Web管理系统`：在Web上可以看到服务运行的各种实时数据情况，以及对服务进行发布、启停、部署等操作；
2. `Registry（路由+管理服务）`：提供服务节点的地址查询、发布、启停、管理等操作，以及对服务上报心跳的管理，通过它实现服务的注册与发现；
3. `Patch（发布管理）`：提供服务的发布功能；
4. `Config（配置中心）`：提供服务配置文件的统一管理功能；
5. `Log（远程日志）`：提供服务打日志到远程的功能；
6. `Stat（调用统计）`：统计业务服务上报的各种调用信息，比如总流量、平均耗时、超时率等，以便对服务出现异常时进行告警；
7. `Property（业务属性）`：统计业务自定义上报的属性信息，比如内存使用大小、队列大小、cache命中率等，以便对服务出现异常时进行告警；

8. `Notify（异常信息）`：统计业务上报的各种异常信息，比如服务状态变跟信息、访问db失败信息等，以便对服务出现异常时进行告警；

> 服务交互流程
![Alt text](./1493870418895.png)
`服务发布流程`：在Web系统上传server的发布包到patch，上传成功后，在web上提交发布server请求，由registry服务传达到node，然后node拉取server的发布包到本地，拉起server服务。

`管理命令流程`：Web系统上的可以提交管理server服务命令请求，由registry服务传达到node服务，然后由node向server发送管理命令。

`心跳上报流程`：server服务运行后，会定期上报心跳到node，node然后把服务心跳信息上报到registry服务，由registry进行统一管理。

`信息上报流程`：server服务运行后，会定期上报统计信息到stat，打印远程日志到log，定期上报属性信息到property、上报异常信息到notify、从config拉取服务配置信息。

`Client访问Server流程`：client可以通过server的对象名Obj间接访问server，Client会从registry上拉取server的路由信息（如ip、port信息），然后根据具体的业务特性（同步或者异步，tcp或者udp方式）访问server(当然client也可以通过ip/port直接访问server)。

> 使用docker 运行Tar web管理系统如下
![Alt text](./1493870595060.png)
